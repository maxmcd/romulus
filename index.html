<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="http://fb.me/react-0.12.2.min.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="//www.parsecdn.com/js/parse-1.3.3.min.js"></script>
    <script src="/vendor/ace.js"></script>
    <link rel="stylesheet" type="text/css" href="/vendor/normalize.css">
    <link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>
    <script type="text/javascript">

        // var Lambda = Parse.Object.extend("Lambda");
        // var privateNote = new Lambda();
        // privateNote.set("content", "wheeee");
        // privateNote.set("user", Parse.User.current())
        // privateNote.setACL(new Parse.ACL(Parse.User.current()));        
        // privateNote.save();

        // // together
        // Parse.initialize("KwUvONDmjowjJdgw8qJzdvOUeYt1gmd07urHwWXf", "5WCPTPxFmUnRx95fRMIDIlosBuHrPjELSAOyE7Lr");
        $(function() {
            Romulus = Parse

            // romulus
            Romulus.initialize("TfJHzuJVZYU97rJc02JrJ8jy8JtsDNe1tbqACmJh", "PXp8V500uu6cMrUeAbuMBXuT1Kev872A7XvET1uG");
            app = {
                files: function() {
                    var Lambda = Parse.Object.extend("Lambda");
                    var query = new Parse.Query(Lambda);
                    query.equalTo("user", Parse.User.current());
                    return query.find()
                    // {
                    //     success: function(userLambdas) {
                    //         console.log(userLambdas)
                    //     }
                    // });
                }, 
                lambas: function() {

                },
                current_user: function() {
                    return Parse.User.current();
                }
            }
        })
    </script>
    <script type="text/jsx">
        // var LikeButton = React.createClass({
        //   getInitialState: function() {
        //     return {liked: false};
        //   },
        //   handleClick: function(event) {
        //     this.setState({liked: !this.state.liked});
        //   },
        //   render: function() {
        //     var text = this.state.liked ? 'like' : 'haven\'t liked';
        //     return (
        //       <p onClick={this.handleClick}>
        //         You {text} this. Click to toggle.
        //       </p>
        //     );
        //   }
        // });

        // React.render(
        //   <LikeButton />,
        //   document.getElementById('example')
        // );



        var CommentForm = React.createClass({
            handleSubmit: function(e) {
                e.preventDefault();
                var username = this.refs.username.getDOMNode().value.trim();
                var password = this.refs.password.getDOMNode().value.trim();
                if (!username || !password) {
                    return;
                }
                Parse.User.logIn(username, password, {
                    success: function(user) {
                        // Do stuff after successful login.
                        console.log(user)
                        console.log("?app_id=" + user.attributes.app_id + "&js_key=" + user.attributes.js_key)
                        React.render(
                            <div>
                                <Console app_id={user.attributes.app_id} js_key={user.attributes.js_key} username={username} />
                                <Editor />
                            </div>,
                            document.getElementById('home')
                        );
                    },
                    error: function(user, error) {
                        // The login failed. Check error to see why.
                        // this.refs.username.getDOMNode().value = '';
                        // this.refs.password.getDOMNode().value = '';
                    }
                });
                // this.props.onCommentSubmit({author: author, text: text});
                return;
            },
            render: function() {
                return (
                    <form className="commentForm" onSubmit={this.handleSubmit}>
                        <input type="text" placeholder="username" ref="username" />
                        <br />
                        <input type="password" placeholder="password" ref="password" />
                        <br />
                        <input type="submit" value="Login" />
                    </form>
                );
            }
        });

        var Console = React.createClass({
          render: function() {
            // return (
            //   <iframe className="console" src={"/console.html?app_id=" + this.props.app_id + "&js_key=" + this.props.js_key + "&username=" + this.props.username} />
            // );
            return (
                <span></span>
            )
          }
        });

        var Editor = React.createClass({
            componentDidMount: function() {
                window.$editor = ace.edit("editor");
                var File = Parse.Object.extend("File");
                var query = new Parse.Query(File);
                query.equalTo("user", Parse.User.current());
                var that = this
                query.find({
                    success: function(userFiles) {
                        $editor.files = userFiles
                        if ($editor.files.length > 0) {
                            $editor.file = $editor.files[0]
                            $editor.setValue($editor.file.attributes.body)
                        }
                        that.setState({data: $editor.files});
                    }
                });
                // editor.setTheme("ace/theme/monokai");
                // editor.getSession().setMode("ace/mode/javascript");
            },
            new_file: function() {
                var File = Parse.Object.extend("File");
                var newFile = new File();
                newFile.set("user", Parse.User.current())
                newFile.setACL(new Parse.ACL(Parse.User.current()));        
                newFile.save();
                $editor.file = newFile
                $editor.files.push(newFile)
            },
            save: function() {
                if (!!$editor.file) {
                    $editor.file.set('body', $editor.getValue())
                    $editor.file.save()
                }
            },
            delete: function() {
                if (!!$editor.file) {
                    var that = this
                    $editor.file.destroy({
                        success: function(myObject) {
                            var index = $editor.files.indexOf($editor.file)
                            $editor.files.splice(index, 1)
                            $editor.file = $editor.files[0]
                            if ($editor.file) {
                                $editor.setValue($editor.file.attributes.body)                                
                            } else {
                                $editor.setValue('')
                            }
                            that.setState({data: $editor.files});
                            
                        },
                        error: function(myObject, error) {
                            // The delete failed.
                            // error is a Parse.Error with an error code and message.
                        }
                    });
                }
            },
            logout: function() {
                Parse.User.logOut()
                React.render(
                    <CommentForm username="maxmcd" />,
                    document.getElementById('home')
                ); 
            },
            getInitialState: function() {
              return {data: []};
            },
            render: function() {
                return (
                    <div className="editor">
                        <div>
                            <FileList data={this.state.data} />
                            <button onClick={this.save}>Save</button>
                            <button onClick={this.delete}>Delete</button>
                            <button onClick={this.new_file}>New</button>
                            <button onClick={this.logout}>Log Out</button>
                        </div>
                        <div id="editor"></div>
                    </div>
                )
            }
        })

        var FileList = React.createClass({
            change: function() {
                var id = this.refs.list.getDOMNode().value
                for (var i=0;i<$editor.files.length;i++) {
                    if ($editor.files[i].id == id) {
                        $editor.file = $editor.files[i]
                        $editor.setValue($editor.files[i].attributes.body)
                    }
                }

            },
            render: function() {
                var options = this.props.data.map(function(file, index) {
                    var selected
                    if ($editor.file && file.id == $editor.file.id) {
                        selected = true
                    } else {
                        selected = false
                    }
                    return (
                        <option value={file.id} selected={selected}>{file.attributes.name}</option>
                    )
                });
                return (
                    <select ref="list" onChange={this.change}>
                        {options}
                    </select>
                )
            }
        })

        if (Parse.User.current()) {
            var current_user = Parse.User.current()
            var app_id = current_user.attributes.app_id
            var js_key = current_user.attributes.js_key
            var username = current_user.attributes.username
            React.render(
                <div>
                    <Console app_id={app_id} js_key={js_key} username={username} />
                    <Editor />
                </div>,
                document.getElementById('home')
            );
        } else {
            React.render(
                <CommentForm username="maxmcd" />,
                document.getElementById('home')
            );                        
        }
    </script>    <!-- <iframe src="/console.html" class="console"></iframe> -->
    <div id="home"></div>
    <script>
      $(function () {






      });
    </script>
</body>
</html>
